name: Update Pages Index

on:
  schedule:
    - cron: "12 1 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate pages-index.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone
          from urllib.error import HTTPError, URLError
          from urllib.request import Request, urlopen

          owner = os.environ["OWNER"]
          token = os.environ["GITHUB_TOKEN"]
          base = "https://api.github.com"

          def api_get(url):
            req = Request(url, headers={
              "Accept": "application/vnd.github+json",
              "Authorization": f"Bearer {token}",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "pages-index-bot"
            })
            with urlopen(req, timeout=20) as resp:
              return json.loads(resp.read().decode("utf-8"))

          def probe_status(url):
            req = Request(url, headers={"User-Agent": "pages-index-bot"})
            try:
              with urlopen(req, timeout=12) as resp:
                return int(getattr(resp, "status", 200))
            except HTTPError as e:
              return int(e.code)
            except URLError:
              return 0
            except Exception:
              return 0

          repos = []
          page = 1
          while True:
            url = f"{base}/users/{owner}/repos?type=public&per_page=100&page={page}"
            batch = api_get(url)
            if not batch:
              break
            repos.extend(batch)
            if len(batch) < 100:
              break
            page += 1

          projects = []
          for r in repos:
            if not r.get("public", False):
              continue
            if not r.get("has_pages", False):
              continue
            name = r.get("name", "")
            if name == f"{owner}.github.io":
              continue

            page_url = f"https://{owner}.github.io/{name}/"
            projects.append({
              "name": name,
              "description": r.get("description") or "",
              "pageUrl": page_url,
              "repoUrl": r.get("html_url") or f"https://github.com/{owner}/{name}",
              "status": probe_status(page_url),
              "topics": r.get("topics") or []
            })

          projects.sort(key=lambda item: item["name"].lower())

          payload = {
            "generatedAt": datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ"),
            "projects": projects,
          }

          with open("pages-index.json", "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
            f.write("\n")
          PY

      - name: Commit changes
        run: |
          if git diff --quiet -- pages-index.json; then
            echo "No changes"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pages-index.json
          git commit -m "chore: auto-update pages index"
          git push
